name: Build Windows x64

on:
  # 手動実行
  workflow_dispatch:
    inputs:
      build_mode:
        description: 'Build mode'
        required: true
        default: 'release'
        type: choice
        options:
          - debug
          - release
      rust_version:
        description: 'Rust version'
        required: true
        default: 'stable'
        type: choice
        options:
          - stable
          - beta
          - nightly
      clear_cache:
        description: 'Clear cache before build'
        required: false
        default: false
        type: boolean

  # プッシュ時の自動実行
  push:
    branches:
      - main
      - develop
    paths:
      - 'codex-rs/**'
      - '.github/workflows/build-windows-x64.yml'

  # PR時の自動実行
  pull_request:
    branches:
      - main
    paths:
      - 'codex-rs/**'
      - '.github/workflows/build-windows-x64.yml'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      build_mode: ${{ steps.set-vars.outputs.build_mode }}
      rust_version: ${{ steps.set-vars.outputs.rust_version }}
    steps:
      - id: set-vars
        run: |
          # workflow_dispatchの場合はinputsを使用、それ以外はデフォルト値
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "build_mode=${{ inputs.build_mode }}" >> $GITHUB_OUTPUT
            echo "rust_version=${{ inputs.rust_version }}" >> $GITHUB_OUTPUT
          else
            echo "build_mode=release" >> $GITHUB_OUTPUT
            echo "rust_version=stable" >> $GITHUB_OUTPUT
          fi

  build:
    needs: setup
    runs-on: windows-latest
    env:
      TARGET: x86_64-pc-windows-msvc
      PLATFORM: windows-x86_64

    steps:
      - name: Free disk space (Windows)
        shell: pwsh
        run: |
          Write-Host "Before cleanup:"
          Get-PSDrive C | Select-Object Used,Free

          # Remove unnecessary pre-installed software
          Remove-Item -Recurse -Force "C:\hostedtoolcache\windows" -ErrorAction SilentlyContinue

          Write-Host "After cleanup:"
          Get-PSDrive C | Select-Object Used,Free

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust (Windows)
        shell: pwsh
        run: |
          echo "Installing Rust toolchain for target: $env:TARGET"
          rustup toolchain install ${{ needs.setup.outputs.rust_version }}
          rustup default ${{ needs.setup.outputs.rust_version }}
          rustup target add $env:TARGET
          rustup show

      - name: Cache cleanup (Windows)
        if: github.event_name == 'workflow_dispatch' && inputs.clear_cache == true
        shell: cmd
        run: |
          if exist "%USERPROFILE%\.cargo\registry\index" rmdir /s /q "%USERPROFILE%\.cargo\registry\index"
          if exist "%USERPROFILE%\.cargo\registry\cache" rmdir /s /q "%USERPROFILE%\.cargo\registry\cache"
          if exist "%USERPROFILE%\.cargo\git" rmdir /s /q "%USERPROFILE%\.cargo\git"
          if exist "target" rmdir /s /q "target"

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-registry-v2-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-v2-

      - name: Cache cargo target (Windows)
        uses: actions/cache@v4
        with:
          path: |
            codex-rs/target/*/build
            codex-rs/target/*/deps
            codex-rs/target/*/examples
            codex-rs/target/*/native
            !codex-rs/target/**/*.pdb
            !codex-rs/target/**/incremental
            !codex-rs/target/**/deps/*.pdb
            !codex-rs/target/**/deps/*.exp
            !codex-rs/target/**/deps/*.lib
            !codex-rs/target/**/examples/*.pdb
          key: ${{ runner.os }}-${{ env.TARGET }}-cargo-target-v3-${{ needs.setup.outputs.build_mode }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ env.TARGET }}-cargo-target-v3-${{ needs.setup.outputs.build_mode }}-
            ${{ runner.os }}-${{ env.TARGET }}-cargo-target-v3-

      - name: Build (Windows)
        working-directory: codex-rs
        shell: cmd
        run: |
          echo Installing target for Windows build
          rustup target add %TARGET%
          if "${{ needs.setup.outputs.build_mode }}" == "release" (
            cargo build --release --target %TARGET% --workspace
          ) else (
            cargo build --target %TARGET% --workspace
          )

      - name: Run tests (Windows)
        working-directory: codex-rs
        shell: pwsh
        run: |
          cargo test --target $env:TARGET --workspace --exclude codex-mcp-server

      - name: Prepare artifacts (Windows)
        working-directory: codex-rs
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path artifacts
          if ("${{ needs.setup.outputs.build_mode }}" -eq "release") {
            $BUILD_DIR = "target\${{ env.TARGET }}\release"
          } else {
            $BUILD_DIR = "target\${{ env.TARGET }}\debug"
          }

          # バイナリをコピー
          Copy-Item "$BUILD_DIR\codex.exe" artifacts\ -ErrorAction SilentlyContinue
          Copy-Item "$BUILD_DIR\codex-exec.exe" artifacts\ -ErrorAction SilentlyContinue
          Copy-Item "$BUILD_DIR\codex-tui.exe" artifacts\ -ErrorAction SilentlyContinue

          # アーカイブ作成
          Compress-Archive -Path artifacts\* -DestinationPath codex-${{ env.PLATFORM }}-${{ needs.setup.outputs.build_mode }}.zip

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: codex-${{ env.PLATFORM }}-${{ needs.setup.outputs.build_mode }}
          path: codex-rs/codex-${{ env.PLATFORM }}-${{ needs.setup.outputs.build_mode }}.zip
          retention-days: 7

      - name: Display build info
        shell: pwsh
        run: |
          Write-Host "Build completed successfully!"
          Write-Host "Platform: $env:PLATFORM"
          Write-Host "Target: $env:TARGET"
          Write-Host "Build mode: ${{ needs.setup.outputs.build_mode }}"
          Write-Host "Rust version: ${{ needs.setup.outputs.rust_version }}"

  summary:
    needs: [setup, build]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Build Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Mode**: ${{ needs.setup.outputs.build_mode }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Rust Version**: ${{ needs.setup.outputs.rust_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "Build artifacts are available in the Actions tab for download." >> $GITHUB_STEP_SUMMARY
